---
title: "Crime in Northwest Philadelphia"
runtime: shiny
output: 
  flexdashboard::flex_dashboard
---

```{r setup, include=FALSE}
library(flexdashboard)
library(leaflet)
library(dplyr)
library(KernSmooth)
library(raster)
library(RColorBrewer)

load("data/points.RData")
load("data/points_year.RData")
load("data/bb.RData")

points_year <- points
points_year$year <- as.POSIXlt(points_year$DISPATCH_DATE)$year + 1900
# points_year$TYPE <- as.character(points_year$TYPE)

#Make a color pallete for crime types
type_pal <- reactive({
    colorFactor(topo.colors(3), points$TYPE)
  })

```

Crime Occurences
================

Select date range and crime type {.sidebar}
-------------------------------------------

```{r}

#Make some inputs
dateRangeInput("dates", "Date range:", start = "2016-01-01", end = "2016-07-24",
               min = "2006-01-01", max = "2016-07-24", startview = "year", separator = "to")

checkboxGroupInput("type", "Crime type:", choices = c("Homicides", "Assaults", "Sexual assaults"),
                   selected = "Homicides")

#Filter points to be displayed based on the inputs
points_filter <- reactive({
    filter(points, DISPATCH_DATE >= as.POSIXct(format(input$dates[1]), format = "%Y-%m-%d")
           & DISPATCH_DATE <=  as.POSIXct(format(input$dates[2]), format = "%Y-%m-%d")
           & TYPE %in% input$type)
  })

```

This map shows the location of different types of violent crime in northwest
Philadelphia from the start of 2006 to July 24, 2016 (the date the data were
accessed). This visualization is incomplete as entries in the database without
an easily accessible latitude and longitude (of which there are many) aren't
shown on the map.

In the original data, the crimes were further subdivided. I've ommited these
categories for the sake of clarity and interpretability of the map. The assault
category was divided into assaults with a firearm, assaults without a firearm,
and all other assaults. Homicides were categorized as either criminal,
negligent, or justifiable. The sexual assault categories were the vaguest. I
chose to include crimes categorized as rape and a catch-all other category of
noncommercial sex offenses. It's very possible that some important nuance has
been lost in these categorizations.

The data were collected from
[OpenDataPhilly](https://www.opendataphilly.org/dataset/crime-incidents) and no
ownership is claimed. This work is licensed under the [MIT
License](https://opensource.org/licenses/MIT)

Column
-------

```{r}
output$map <- renderLeaflet({
    leaflet(points) %>%
      addProviderTiles("Stamen.TonerLite") %>%
      fitBounds(~min(LON), ~min(LAT), ~max(LON), ~max(LAT))
  })

observe({
    pal <- type_pal()
    leafletProxy("map", data = points_filter()) %>%
      clearMarkers() %>%
      addCircleMarkers(~LON, ~LAT, color = ~pal(TYPE), radius = 3, opacity = 1) %>%
      clearControls() %>%
      addLegend("bottomright", pal, ~TYPE, title = "Crime type")
  })

tags$style(type = "text/css", "#map {height: calc(100vh - 80px) !important;}")
leafletOutput("map")
```

Crime Density
=============

Select year {.sidebar}
----------------------

```{r}
#Make inputs
sliderInput("year_heat", "Year:", min = 2006, max = 2016, value = 2016, step = 1,
            ticks = FALSE, round = TRUE,
            sep = "") #check out animate once everything is working...
radioButtons("type_heat", "Crime type:",
             choices = c("Homicides", "Assaults", "Sexual assaults"), 
             selected = "Homicides")

points_filter_heat <- reactive({
  shiny::validate(need(input$year_heat, label = "year"))
  points_year %>% 
   filter(year == input$year_heat
            & points_year$TYPE %in% input$type_heat)
  })

kde <- reactive({
  bkde2D(cbind(points_filter_heat()$LON, points_filter_heat()$LAT),
         bandwidth = c(bw.nrd(points_filter_heat()$LON), bw.nrd(points_filter_heat()$LAT)))
})

norm <- reactive({
  int <- 0
  for(i in 1:(nrow(kde()$fhat)-1)){
    for(j in 1:(ncol(kde()$fhat)-1)){
      int <- int + kde()$fhat[i,j]*(kde()$x1[j+1]-kde()$x1[j])*(kde()$x2[i+1]-kde()$x2[1])
    }
  }
  int
})

contours <- reactive({
  contourLines(kde()$x1, kde()$x2, kde()$fhat)
})


# heat_raster <- reactive({
#   raster(list(x = kde()$x1, y = kde()$x2, z = kde()$fhat))
# })

pal <- reactive({
  colorFactor("Reds",
               unique(unlist(contours())[grepl("level", attr(unlist(contours()), "names"))]))
})

```


Column
-------

```{r}
output$map_heat <- renderLeaflet({
    leaflet(points_year) %>%
    addProviderTiles("Stamen.TonerLite") %>%
    fitBounds(~min(LON), ~min(LAT), ~max(LON), ~max(LAT))
  })

# observe({
#   leafletProxy("map_heat") %>%
#     clearImages() %>%
#     addRasterImage(heat_raster(), colors = pal())
#   })


observe({
  pal_temp <- pal()
  norm_temp <- norm()
  values_temp <- unique(unlist(contours())[grepl("level", attr(unlist(contours()), "names"))])
  leafletProxy("map_heat") %>%
    clearShapes()
  
  for(i in 1:length(contours())){
    leafletProxy("map_heat") %>% 
      addPolylines(contours()[[i]]$x, contours()[[i]]$y, color = pal_temp(contours()[[i]]$level), weight = 4)
  }
  
  leafletProxy("map_heat") %>% 
    clearControls() %>% 
    addLegend("bottomleft", pal = pal_temp, values = values_temp, labFormat = labelFormat(digits = 3, transform = function(x) x/norm_temp))
  })

tags$style(type = "text/css", "#map_heat {height: calc(100vh - 80px) !important;}")
leafletOutput("map_heat")
```
